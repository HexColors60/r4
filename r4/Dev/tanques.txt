| Tanques War
| 2016 - Itinerario
|-----------------
^r4/lib/gui.txt
^r4/lib/part16.txt
^r4/dev/tanque.spr

|tanque1
#xt -0.5 #yt #dt 0 #vt #rt #ct #adt
#xb #yb #db #vxb #vyb #tb
#danio

|tanque2
#xt2 0.5 #yt2 #dt2 0.5 #vt2 #rt2 #ct2 #adt2
#xb2 #yb2 #db2 #vxb2 #vyb2 #tb2
#danio2

| fx
#fx 0 0


:fpos
	8 >> sh 2/ + swap
	8 >> sw 2/ + swap
	pos ;
	
:dibujobala
	tb 0? ( drop ; ) drop
	48 qdim
	xb yb fpos
	'misil db rnsprite

	vxb 'xb +!
	vyb 'yb +!
	-1 'tb +! ;

:dibujobala2
	tb2 0? ( drop ; ) drop
	48 qdim
	xb2 yb2 fpos
	'misil db2 rnsprite

	vxb2 'xb2 +!
	vyb2 'yb2 +!
	-1 'tb2 +! ;

:disparo
	tb 1? ( drop ; ) drop
	xt 'xb !
	yt 'yb !
	dt 'db !
	dt sincos
	0.01 *. 'vxb !
	0.01 *. 'vyb !
	75 'tb ! ;

:disparo2
	tb2 1? ( drop ; ) drop
	xt2 'xb2 !
	yt2 'yb2 !
	dt2 'db2 !
	dt2 sincos
	0.01 *. 'vxb2 !
	0.01 *. 'vyb2 !
	75 'tb2 ! ;


:dibujotanque
	80 qdim
	xt yt fpos
	'stanque dt rnsprite ;

:dibujotanque2
	80 qdim
	xt2 yt2 fpos
	'stanque dt2 rnsprite ;

:avanzatanque
	dt sincos
	vt *. 'xt +!
	vt *. 'yt +!
	;

:avanzatanque2
	dt2 sincos
	vt2 *. 'xt2 +!
	vt2 *. 'yt2 +!
	;

:teclastanque
	[ 0.001 'adt ! ; ] <le>
	[ -0.001 'adt ! ; ] <ri>
	adt 'dt +!
	[ 0 'adt ! ; ] dup >le< >ri<
	[ 0.001 'vt ! ; ] <up>
	[ 0 'vt ! ; ] >up<
	 'disparo <dn>
	;

:teclastanque2
	[ 0.001 'adt2 ! ; ] 30 ?key
	[ -0.001 'adt2 ! ; ] 32 ?key
	adt2 'dt2 +!
	[ 0 'adt2 ! ; ] dup 30 ?ukey 32 ?ukey
	[ 0.001 'vt2 ! ; ] 17 ?key
	[ 0 'vt2 ! ; ] 17 ?ukey
	 'disparo2 31 ?key
	;

:distancia
	 rot - dup *. >r
	 - dup *. r> +
	 sqrt. ;

:golpet1
	10 'danio +!
	0 'tb2 !
	;

:golpet2
	10 'danio2 +!
	0 'tb !
	;

:colision
	tb 1? (
		xb yb xt2 yt2 distancia
		0.05 <? ( golpet2 ) drop
	) drop

	tb2 1? (
		xb2 yb2 xt yt distancia
		0.05 <? ( golpet1 ) drop
	) drop
	;

:ganotanque2
	show clrscr
		"gano tanque2!" print
		'exit >esc< ;

:ganotanque1
	show clrscr
		"gano tanque1!" print
		'exit >esc< ;

:victoria
	danio 99 >? ( ganotanque2 exit ) drop
	danio2 99 >? ( ganotanque1 exit ) drop
	;

|-----------------
:r0001 rand 0.001 mod ;
:r001 rand 0.01 mod ;
:r01 rand 0.1 mod ;

:phumo
	dup @ 1- 0? ( nip ; )
	dup 2* alpha
	swap !+
	>r
	r@+	r@+ fpos
	r@+ r 12 - +!	| VX
	r@+ r 12 - +!	| VY
	r@+ qdim
	r@+ r@+ rnsprite
	r@+ r 8 - +!

	rdrop
	;

:+humo | x y --
	'phumo 'fx p!+ >r
	127 r!+ | vida
	r!+ r!+ | x y
	r0001 r!+ r0001 r!+ | vx vy
	48 r!+
	'humo1 r!+
	0 r!+
	r001 r!+
	rdrop ;


:reset
	'fx p.clear
	;

:main
	show clrscr
		"tanques " print
		danio "t1: %d " print
		danio2 "t2: %d" print

		dibujobala
		dibujobala2

		dibujotanque
		dibujotanque2
		'fx p.draw 255 alpha

		avanzatanque
		avanzatanque2

		teclastanque
		teclastanque2

		colision
		victoria

		'+humo <f1>
		'exit >esc<
		cminiflecha ;

:memoria
	mark
	1000 'fx p.ini

	;

: memoria main ;
