| triangle to quadtree
| PHREDA 2018
^r4/lib/gui.txt
^r4/lib/loadimg.txt
^r4/lib/trace.txt

#:tritexture 0

#vertex
756 32 80 $ff0000
10400 -520 1520 $ff
600 160 1000 $ff00ff

#vertex
756 32 80 $ff0000
5578 -244 800 $ff
678 96 540 $ff00ff

|----------------------------------
#ox #oy
:3dini
	512 sw - 2/ neg 'ox !
	512 sh - 2/ neg 'oy !
	matini ;

:c9 | x z -- x'
	2/ 0 swap over | x 0 z 0  | x dx z cx
	pick3 >? ( over - rot )( over + rot 256 + ) rot 2/ rot
		| cx>x --> cx-=z : cx+=z dx+=256 ; z=z/2
	pick3 >? ( over - rot )( over + rot 128 + ) rot 2/ rot
		| cx>x --> cx-=z : cx+=z dx+=128 ; z=z/2
	pick3 >? ( over - rot )( over + rot 64 + ) rot 2/ rot
	pick3 >? ( over - rot )( over + rot 32 + ) rot 2/ rot
	pick3 >? ( over - rot )( over + rot 16 + ) rot 2/ rot
	pick3 >? ( over - rot )( over + rot 8 + ) rot 2/ rot
	pick3 >? ( over - rot )( over + rot 4+ ) rot 2/ rot
	pick3 >? ( over - rot )( over + rot 2 + ) rot 2/ rot
	pick3 >? ( 2drop )( 2drop 1+ )
	nip ;

| bitrick..sin saltos

| dup pick4 - 31 >> 	| x dx z cx sign
| dup 256 and >r
| pick2 over neg xor +	| x dx z cx z+
| +						| x dx z cx+-z
| rot r> +				| x z cx+-z dx+lev
| rot 2/ rot			| x dx' z' cx'

:c9b |x z -- x'
	2/ 0 swap over | x 0 z 0  | x dx z cx

	dup pick4 - 31 >> dup
	256 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	128 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	64 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	32 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	16 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	8 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

   	dup pick4 - 31 >> dup
	4 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	2 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot

	dup pick4 - 31 >> dup
	1 and >r pick2 over neg xor +
	+ rot r> + rot 2/ rot
	2drop nip
	;

:3dpro | x y z -- x y
	rot over c9 ox + rot rot c9 oy + ;
|----------------------------------

:viewire | 'vertex --
 	>b
 	b@+ b@+ b@+ 3dpro 2dup op 4 b+
 	b@+ b@+ b@+ 3dpro line 4 b+
 	b@+ b@+ b@+ 3dpro line
	line
	;

|------------------------
#stackv

|--
| x cx y cy z dxy col ccol
| 0 4 8 12 16 20  24  28

:drawp | adr -- adr
	dup 20 + @+
	dup 9 >> $1ff and oy + sh clamp0max
	swap $1ff and ox + sw clamp0max
	setxy
	@ a!+ ;

:samecuadrant | adr -- adr 1/0
	dup >a
	a@+ a@+ - a@+ a@+ - | (x<cx -) (y<cy -)
	16 a+		| xs ys
	a@+ a@+ -	| xs ys x2s
	rot xor	$80000000 and? ( 2drop 0 ; ) | ys x2s
	a@+ a@+ -	| ys x2s y2s
	rot xor	$80000000 and? ( 2drop 0 ; ) | x2s y2s
	16 a+		| xs ys
	a@+ a@+ -	| xs ys x2s
	rot xor $80000000 and? ( 2drop 0 ; ) | ys x2s
	a@+ a@+ -	| ys x2s y2s
	rot xor	$80000000 and? ( 2drop 0 ; ) | x2s y2s
	2drop 1 ;

| x cx y cy z dxy col ccol
| 0 4 8 12 16 20  24  28
| cx>x --> cx-=z : cx+=z dx+=256 ; z=z/2
:advvert
	a> 16 + @	| z
	a@+ a@ swap | cx x
	>? ( over - a!+ )( over + a!+ pick2 a> 12 + +! )
	a@+ a@ swap
	>? ( swap - a!+ )( swap + a!+ over a> 4+ +! )
	16 a+ ;

:advancecuadrant | adr -- adr
	dup >a
	advvert advvert advvert ;

:cpyvert | --	a:o b:d
	a@+ b!+ a@+ b!+ a@+ b!+ a@+ b!+
	a@+ b!+ a@+ b!+ a@+ b!+ a@+ b!+
	;

:avgvert | o1 --	a:o2 b:d
	@+ a@+ + 2/ b!+ @+ a@+ + 2/ b!+
	@+ a@+ + 2/ b!+ @+ a@+ + 2/ b!+
	@+ a@+ + 2/ b!+ @+ a@+ nip |+ 2/
	b!+
	@+ a@+ + 2/ b!+ @+ a@+ + 2/ b!+
	drop
	;

:verxy
	@+ swap 4+ @+ swap 4+ @ 2* 3dpro ;

:printv
	@+ "x:%d " print
	@+ "xc:%d " print
	@+ "y:%d " print
	@+ "yc:%d " print
	@+ "z:%d " print
	@+ "dxy:%h " print
	@+ "col:%h " print
	@+ drop |"dcol:%h " print
	cr
	allowchome
	;

:dump | stakc level --
	clrscr
	dup "%d " print cr
	stackv ( pick2 <? )(
		rand ink
    	dup verxy >r >r
		printv
		dup verxy >r >r
		printv
		dup verxy 2dup op r> r> line r> r> line line
		printv
		) drop
	show 'exit >esc< ;

:recurseview | stackv level -- stackv level
|	dump

	( swap samecuadrant 1? )( drop
		advancecuadrant
		swap 2/ 0? ( 1+ swap drawp 96 - swap ; )
		) drop swap
	| stackv level

	| t1
	over >a
	over 96 + >b
	cpyvert over avgvert over avgvert
	swap 96 + swap recurseview

	| t2
	over >a
	over 96 + >b
	over 32 + avgvert cpyvert over 32 + avgvert
	swap 96 + swap recurseview

	| t3
	over >a
	over 96 + >b
	over 64 + avgvert over 64 + avgvert cpyvert
	swap 96 + swap recurseview

	| t4
	over >a
	over 96 + >b
	over 32 + avgvert over 64 + avgvert over avgvert
	swap 96 + swap recurseview

	swap 96 - swap 2* ;


|---------
:dotp | adr --
	20 + @+
	dup 9 >> $1ff and oy + |sh clamp0max
	swap $1ff and ox + |sw clamp0max
	swap setxy
	@ a!+ ;

:quaview | stackv level --
	dump

	( swap samecuadrant 1? )( drop
		advancecuadrant
		swap 2/ 0? ( drop dotp  ; )
		) drop swap
	| stackv level

	| t1
	over >a
	over 96 + >b
	cpyvert over avgvert over avgvert
	over 96 + over quaview

	| t2
	over >a
	over 96 + >b
	over 32 + avgvert cpyvert over 32 + avgvert
	over 96 + over quaview

	| t3
	over >a
	over 96 + >b
	over 64 + avgvert over 64 + avgvert cpyvert
	over 96 + over quaview

	| t4
	over >a
	over 96 + >b
	over 32 + avgvert over 64 + avgvert over avgvert
	swap 96 + swap quaview

	2drop ;


:viewqua | 'vertex --
	>b stackv >a
	b@+ a!+ 0 a!+ b@+ a!+ 0 a!+ b@+ 2/ a!+ 0 a!+ b@+ a!+ 0 a!+
	b@+ a!+ 0 a!+ b@+ a!+ 0 a!+ b@+ 2/ a!+ 0 a!+ b@+ a!+ 0 a!+
	b@+ a!+ 0 a!+ b@+ a!+ 0 a!+ b@+ 2/ a!+ 0 a!+ b@+ a!+ 0 a!+

	stackv 256 quaview
	;


:main
	mark
	"media/obj/cube.png" loadimg 'tritexture !
	here 'stackv !
	33
	show clrscr
		3dini
		dup "%d" print cr

|		xymouse swap 'vertex !+ !
|		'vertex viewire
		'vertex viewqua

		'exit >esc< ;
: main ;