| PHREDA 2016
| 2017 idea uno negativo
|--------------------------
^r4/lib/gui.txt
^r4/lib/loadpng.txt
^r4/lib/trace.txt

| x y z uv
#vertex
100 50 40 $00000000
200 100 120 $ffff0000
60 160 100 $0000ffff

#texture 0

#minx #maxx #miny #maxy
#va0 #va1 #va2
#vb0 #vb1 #vb2
#bc0 #bc1 #bc2
#inv_p0z #inv_p1z #inv_p2z
#inv_p0u #inv_p1u #inv_p2u
#inv_p0v #inv_p1v #inv_p2v

#inv_Pz #inv_Pu #inv_Pv
#oiz #o0 #o1 #o2
#u #v

:loop | xv0 yv0 y x -- xv0 yv0 y x
	pick3 over - 'va2 !
	pick2 pick2 - 'vb2 !
	va1 vb2 * va2 vb1 * - 'bc0 !
	va2 vb0 * va0 vb2 * - 'bc1 !
	1.0 bc0 bc1 + oiz * - 'o0 !
	bc1 oiz * 'o1 !
	bc0 oiz * 'o2 !
	o0 o1 or o2 or -? ( drop 4 a+ ; ) drop
	inv_p0z o0 *. inv_p1z o1 *. + inv_p2z o2 *. +
	'inv_Pz !

|      // Buffer offset on the screen and z-buffer
|      bo = y * buffer_width + x;

 |     // Z-buffer test rejection, updating
 |     if (heap_zbuffer_ptr[bo] > inv_Pz) continue;
|      heap_zbuffer_ptr[bo] = inv_Pz;

	|---- correct
	inv_p0u o0 *. inv_p1u o1 *. + inv_p2u o2 *. +
	inv_Pz /. 'u !

	inv_p0v o0 *. inv_p1v o1 *. + inv_p2v o2 *. +
	inv_Pz /. 'v !
|        u = ( (inv_Pu / inv_Pz) * texmaxu );
|        v = ( (inv_Pv / inv_Pz) * texmaxv );

    |---- incorrect
|        u = (u0 * o0 + u1 * o1 + u2 * o2) * texmaxu;
|        v = (v0 * o0 + v1 * o1 + v2 * o2) * texmaxv;
	v 16 >> $ff and 8 <<
	u 16 >> $ff and or

	2 << 4+
	texture + @
|	drop $ff
	a!+

|      to = ((int)v * texwid << BIT_SHIFT_PER_PIXEL) + ((int)u << BIT_SHIFT_PER_PIXEL);
|      r = Math_min( 255, (int)(((float)texels[ to + 0 ]) * light) );
|      g = Math_min( 255, (int)(((float)texels[ to + 1 ]) * light) );
|     b = Math_min( 255, (int)(((float)texels[ to + 2 ]) * light) );
	;

:tritex | ad
	dup @ over 16 + @ pick2 32 + @ | x0 x1 x2
	dup pick3 - 'va0 ! over pick3 - 'va1 !
	pick2 pick2 pick2
	min min 'minx ! max max 'maxx !
	dup 4+ @ over 20 + @ pick2 36 + @ | y0 y1 y2
	dup pick3 - 'vb0 ! over pick3 - 'vb1 !
	pick2 pick2 pick2
	min min 'miny ! max max 'maxy !

	|clip&reject..

	va0 vb1 * va1 vb0 * - 0? ( 2drop ; )
	1.0 over / 'oiz !
	'bc2 !
	1.0 over 8 + @ 0? ( 1+ ) /
	over 12 + @ dup >r
	16 0>> over * 'inv_p0u !
	r> $ffff and over * 'inv_p0v !
	'inv_p0z !
	1.0 over 24 + @ 0? ( 1+ ) /
	over 28 + @ dup >r
	16 0>> over * 'inv_p1u !
	r> $ffff and over * 'inv_p1v !
	'inv_p1z !
	1.0 over 40 + @ 0? ( 1+ ) /
	over 44 + @ dup >r
	16 0>> over * 'inv_p2u !
	r> $ffff and over * 'inv_p2v !
	'inv_p2z !
	@+ swap @	| vx0 vy0
	minx miny setxy
	miny ( maxy <? )(
		minx ( maxx <? )(
			loop
			1+ ) drop
		sw maxx minx - - 2 << a+
		1+ ) 3drop ;

|-------------------------
:main
	33
	mark
	"media/obj/Mario/Mario_body.png" loadpng 'texture !
	show clrscr
		dup "%d" print cr

|		xymouse swap 'vertex !+ !

		'vertex tritex

		blanco
		'vertex >b
		b@+ b@+ 2dup op
		8 b+
		b@+ b@+ line
		8 b+
		b@+ b@ line line

		'exit >esc<
		cminiflecha
		;

: main ;
