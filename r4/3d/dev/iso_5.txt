| PHREDA 2017
| Solo ISO, ray casting test
|--------------------
^r4/lib/gui.txt
^r4/lib/morton.txt
^r4/lib/zbuffer.txt
^r4/lib/zoom.txt

^r4/lib/trace.txt

#oclon
#oclon2

#x0 220 #y0 200 #z0 100
#x1 300 #y1 180 #z1 150
#x2 280 #y2 220 #z2 200
#x3 240 #y3 300 #z3 200

|#x0 220 #y0 200 #z0 100
|#x1 224 #y1 204	#z1 150
|#x2 224 #y2 196 #z2 200
|#x3 220 #y3 204 #z3 200

| 32*niveles
#ivecpos )( 320

#$base
#$magic
#$octree
#$pixels
#$paleta

#nzmin 2
#szm 5

:drawaxis
	violeta x0 y0 4 box
	azul x0 y0 op x1 y1 2dup line 4 box
	rojo x0 y0 op x2 y2 2dup line 4 box
	verde x0 y0 op x3 y3 2dup line 4 box
	;

|--------------------------------------
:3do! | octree --
	dup '$base !
	dup 28 + '$octree !
	@+ '$magic !
	@ $octree + '$pixels !
	;

:octcolor | oct -- color
    $octree - $pixels + @ ;

::oct++ | adr -- adr bitmask
	@+ dup 8 >> 2 << rot + swap $ff and ;

|----------------------------- rasterize
#xmin
#ymin
#zmin

#norden
#lenx #leny #lenz
#ilev
#blev )( 120

#nowz
#nowzbuf
#advzbuf

#stacko )( 1024
#stacko> 'stacko

:stack@ | -- top
	-4 'stacko> +! stacko> @ ;

:stack2@ | -- a b
	stacko> 8 - dup 'stacko> !
	@+ swap @ swap ;

:stack! | top --
	stacko> !+ 'stacko> ! ;

:stack2! | a b --
	stacko> !+ !+ 'stacko> ! ;


:colordot	octcolor px!+ ;
:skipdot    1 px+! ;

:colordotr 	octcolor z0 'nowzbuf !+ zbo + ! ;
:skipdotr	4 'nowzbuf +! ;

|---------------------------------------------
#leny0
#lenx0
#xyznow
#xyznow0

#imask $7ff7fdff $3ff3fcff $1ff1fc7f $0ff0fc3f $07f07c1f $03f03c0f $01f01c07 $00f00c03 $00700401

:packxyz | x y z -- zyx
	zmin - 20 <<
	swap ymin - 10 << or
	swap xmin - or ;

:calpaso | nro vec val -- nro vec nval
	pick2 >> dup $00100401 and swap 2/
	pick3 2 << 'imask + @ and + ;

:preup | child --
	ilev swap
	2 << 'ivecpos + @
	over >> dup $00100401 and swap 2/
	pick2 2 << 'imask + @ and +
	xyznow + 'xyznow0 !
	1+
	lenx over >> 'lenx0 !
	leny swap >> 'leny0 !
	;

:preup | child --
	ilev 1+ swap
	2 << over 5 << + 'ivecpos + @
	xyznow + 'xyznow0 !
	lenx over >> 'lenx0 !
	leny swap >> 'leny0 !
	;

:uplevel | --
|	xyznow ilev 2 << 'sprev + !
	xyznow0 'xyznow !
	1 'ilev +! ;

:dnlevel
	-1 'ilev +!
|	ilev 2 << 'sprev + @ 'xyznow ! ;

|-----------------------------------------
#maxlev
#xmask )( 2048
#ymask )( 2048
#xmvec 0 0 0 0 0 0 0 0 0 0 0 0
#ymvec 0 0 0 0 0 0 0 0 0 0 0 0

|---- full
:buscarhijo | mask -- hijo/-1
	norden (
		1 over $7 and << | hijo
		pick2 and? ( drop $7 and nip ; ) drop
		4 >> -1 =? ) nip ;

:childxy | lev y x nro -- lev y x sx sy
	2 << 'ivecpos + @
	dup $3ff and pick4 1+ >> swap 10 >> $3ff and pick4 1+ >> ;

|	2 << pick3 1+ 5 << + 'ivecpos + @
|	dup $3ff and swap 10 >> $3ff and ;

:getyxmask | lev y x --
	pick2 2 <<
	dup 'ymvec + @ pick3 + c@
	swap 'xmvec + @ pick2 + c@ and ;

|	pick2 3 << 'yxmvec + @+ pick3 + c@ swap @ pick3 + c@ and ;

:rayfull
	2dup 0  | yn xn level
	( rot rot
		getyxmask
		0? ( 4drop 1 px+! ; ) | optimiza
		buscarhijo -? ( 4drop 1 px+! ; ) | y x c
		childxy							| y x xs ys
		rot rot -
		rot rot -
		swap 		| y x
		rot 1+ maxlev =? ) 3drop
	ink@ px!+
	;

:drawf | x y z --
	xmin ymin setxy
	sw lenx -
	0 ( leny <? )(
		0 ( lenx <? )(
			rayfull
			1+ ) drop
		over px+!
		1+ ) 2drop ;

|-------------------------------
:.h
	$ff and $10 <? ( "0%h" )( "%h" ) print ;

:dm
	( @+ 1? )(
		over @ swap
		( over <? )( c@+ .h "." print ) 2drop
		cr ) 2drop ;

:dumpmask
|	'xmask lenx ( 1? )( 1- swap c@+ .h swap ) 2drop cr
	'xmvec dm cr
|	'ymask leny ( 1? )( 1- swap c@+ .h swap ) 2drop cr
	'ymvec dm cr
	;

|-------------------------------
:fillx | child v x -- child
	'xmask +
	lenx 2/ ( 1? )( 1- | child v xmin len
		pick3 pick2 c+!
		swap 1+ swap ) 2drop ;

:filly | child y -- child
	'ymask +
	leny 2/ ( 1? )( 1- | child ymin len
		pick2 pick2 c+!
		swap 1+ swap ) 2drop ;

:calclevels | cnt mask vec --
	>r dup	| c xo xo
	pick2 2 << +	| c xo xd r:vv
	(	over r!+	| c xo xd r:vv
		pick2 ( 1? )( 1- >r			| c xo xd c
			swap @+
			dup $ff00ff and swap 8 >> or $ff00ff and dup 8 >> or
			rot	w!+					| c xo xd
			r> ) drop				| c xo xd
		nip dup pick2 2* - swap		| calcula origen otra vez
		rot 2/ 1? )( rot rot )      | xo xd c
	over r!+
|	pick2 @ dup $ff00ff and swap 8 >> or $ff00ff and dup 8 >> or
|	rot w!+
 	r!+
	2drop rdrop ;

:calcmask
	'xmask lenx 2 >> 1+ ( 1? )( 1- 0 rot !+ swap ) 2drop
	'ymask leny 2 >> 1+ ( 1? )( 1- 0 rot !+ swap ) 2drop

	'ivecpos >r
	$1 ( $100 <? )( r@+
		dup $3ff and 2/ fillx | child xmin
		10 >> $3ff and 2/ filly
		2* ) drop rdrop

	lenx 3 + 2 >> 'xmask 'xmvec calclevels
	leny 3 + 2 >> 'ymask 'ymvec calclevels
	;

:drawfull | color --
	ink |zo!

	0 0 x1 x0 - -? ( rot + swap )( + )
	x2 x0 - -? ( rot + swap )( + )
	x3 x0 - -? ( rot + swap )( + )
	over - 'lenx ! x0 + 'xmin !
	0 0 y1 y0 - -? ( rot + swap )( + )
	y2 y0 - -? ( rot + swap )( + )
	y3 y0 - -? ( rot + swap )( + )
	over - 'leny ! y0 + 'ymin !
	0 0 z1 z0 - -? ( rot + swap )( + )
	z2 z0 - -? ( rot + swap )( + )
	z3 z0 - -? ( rot + swap )( + )
	over - 'lenz ! z0 + 'zmin !

	'ivecpos >r
	x0 y0 z0 packxyz r!+
	x1 y1 z1 packxyz r!+
	x2 y2 z2 packxyz r!+
	x1 x2 + x0 -
	y1 y2 + y0 -
	z1 z2 + z0 - packxyz r!+
	x3 y3 z3 packxyz r!+
	x3 x1 + x0 -
	y3 y1 + y0 -
	z3 z1 + z0 - packxyz r!+
	x3 x2 + x0 -
	y3 y2 + y0 -
	z3 z2 + z0 - packxyz r!+
	x3 x1 + x0 - x2 + x0 -
	y3 y1 + y0 - y2 + y0 -
	z3 z1 + z0 - z2 + z0 - packxyz r!+
	rdrop

	30 lenx leny min clz - 'maxlev ! | -2
	calcmask
	szm 'nzmin !
	nzmin 0
	over %1000 or or
	over 1 xor %1000 or 4 << or
	over 2 xor %1000 or 8 << or
	over 4 xor %1000 or 12 << or
	over 3 xor %1000 or 16 << or
	over 5 xor %1000 or 20 << or
	over 6 xor %1000 or 24 << or
	swap 7 xor %1000 or 28 << or
|	dup $77777777 and "%h" print
	'norden !
	drawf
	;

|---------------

|	pick4 swap 2 << 'ivecpos + @		| lev vec
|	over >> dup $00100401 and swap 2/	| lev vec>> vec2/
|	rot 2 << 'imask + @ and + ;			| syx

|	2 << 'ivecpos + @ ilev 1+ >>
|	ilev 2 << 'imask + @ and ;

|	2 << 'ivecpos + @
|	dup $3ff and pick4 1+ >> swap 10 >> $3ff and pick4 1+ >> ;

|	2 << pick3 1+ 5 << + 'ivecpos + @
|	dup $3ff and swap 10 >> $3ff and ;

:childxy | lev xy noc hijo -- lev xy noc sxsy
	2 << 'ivecpos + @ pick3 1+ >>
	pick3 2 << 'imask + @ and ;

:childxy- | lev norden oc xy hijo --  lev norden noc sxsy
	2 << 'ivecpos + @ pick4 >>
	pick4 1- 2 << 'imask + @ and - ;

:getyxmask | lev no yx oc -- lev no yx oc yxmask
	pick3 2 << 'ymvec + @ pick2 10 >> $ff and + c@
	pick4 2 << 'xmvec + @ pick3 $ff and + c@ and ;

:nextchild | mask norden -- hijo/-1
	( 1 over $7 and << | hijo
		pick2 and? ( drop $7 and nip ; ) drop
		4 >> -1 =? ) nip ;

| baja nivel
|	lev 1-			| lev
|	xy c xhildxy-	| xy
|	stack@			| norden,octree

:dnlevel | lev xy  -- yx oc norden lev
	stack2@ rot	| lev norden oc yx
	pick2 $7 and childxy- 	| lev norden oc yxo
	swap 2swap				| yxo oc lev norden
	4 >> swap 1- ;

:search | lev norden xy oc -- yx oc norden lev
    getyxmask			| lev norden xy oc yxmask
	over @ and			| lev norden xy oc bitmask
|	0? ( 2drop nip dnlevel ; )
	pick3 nextchild		| lev norden xy oc hijo/-1
	-? ( 2drop nip dnlevel ; )

| sube nivel
|	lev 1+			| lev
|	xy c childxy+	| xy
|	stack! 			| norden,octree

	>r rot over			| lev xy oc norden oc r: hijo
	stack2!				| lev xy oc  r: hijo
	@+ dup 1 r << 1- and popcnt 2 << swap 8 >> 2 << + +		| lev xy noc
	r> childxy			| lev xy noc sxy
	rot + swap rot 		| yxn noc lev
	1+ norden swap		| yxn noc norden lev
	;

:raycast | y x octree -- y x
	'stacko 8 + 'stacko> !
	pick2 10 << pick2 or	| oc yx
	swap norden 0			| yx oc norden lev
	( maxlev <? )( swap 2swap	| lev norden xy oc
		pick3 pick3 pick3 pick3 "%h %h %h %d." ,print
	    $pixels >=? ( colordot 3drop ; )
	    search					| yx ox norden lev
		-? ( 4drop skipdot ; )
		) 2drop nip
	colordot ;

:drawi
	mark
	xmin ymin setxy
	sw lenx -
	0 ( leny <? )(
		0 ( lenx <? )(

			2dup "(%d %d)" ,print ,cr

			pick3 raycast

			,cr
			"log.txt" savemem

			1+ ) drop
		over px+!
		1+ ) 3drop ;

:drawiso | color --
	3do!

	0 0 x1 x0 - -? ( rot + swap )( + )
	x2 x0 - -? ( rot + swap )( + )
	x3 x0 - -? ( rot + swap )( + )
	over - 'lenx ! x0 + 'xmin !
	0 0 y1 y0 - -? ( rot + swap )( + )
	y2 y0 - -? ( rot + swap )( + )
	y3 y0 - -? ( rot + swap )( + )
	over - 'leny ! y0 + 'ymin !
	0 0 z1 z0 - -? ( rot + swap )( + )
	z2 z0 - -? ( rot + swap )( + )
	z3 z0 - -? ( rot + swap )( + )
	over - 'lenz ! z0 + 'zmin !

	'ivecpos >r
	x0 y0 z0 packxyz r!+
	x1 y1 z1 packxyz r!+
	x2 y2 z2 packxyz r!+
	x1 x2 + x0 -
	y1 y2 + y0 -
	z1 z2 + z0 - packxyz r!+
	x3 y3 z3 packxyz r!+
	x3 x1 + x0 -
	y3 y1 + y0 -
	z3 z1 + z0 - packxyz r!+
	x3 x2 + x0 -
	y3 y2 + y0 -
	z3 z2 + z0 - packxyz r!+
	x3 x1 + x0 - x2 + x0 -
	y3 y1 + y0 - y2 + y0 -
	z3 z1 + z0 - z2 + z0 - packxyz r!+
	rdrop

	32 lenx leny min clz - 2 - 'maxlev !

	calcmask
	szm 'nzmin !
	nzmin 0
	over %1000 or or
	over 1 xor %1000 or 4 << or
	over 2 xor %1000 or 8 << or
	over 4 xor %1000 or 12 << or
	over 3 xor %1000 or 16 << or
	over 5 xor %1000 or 20 << or
	over 6 xor %1000 or 24 << or
	swap 7 xor %1000 or 28 << or
	'norden !
	$octree drawi
	;

|--------------------------------
:drawxm
	c@+
	$1 ( $100 <? )(
		over and? ( $ff0000 )( 0 ) px!+
		sw 1- px+!
		2* ) 2drop ;

:drawym
	c@+
	$1 ( $100 <? )(
		over and? ( $ff0000 )( 0 ) px!+
		2* ) 2drop ;

:drawrules
	'xmask
	0 ( lenx <? )( swap
    	over xmin + ymin 10 - setxy drawxm
		swap 1+ ) 2drop
	'ymask
	0 ( leny <? )( swap
		xmin 10 - pick2 ymin + setxy drawym
		swap 1+ ) 2drop
	;

|--------------------------------
:getnn | child -- x y
	2 << 'ivecpos + @
	dup $3ff and xmin +
	swap 10 >> $3ff and ymin +
	;

:drawaxisfull
	verde
	0 getnn op
	1 getnn line
	3 getnn line
	2 getnn line
	0 getnn line

	4 getnn op
	5 getnn line
	7 getnn line
	6 getnn line
	4 getnn line
	;

|--------------------------------
:load3do | "" -- moctree
	here dup rot load 'here ! ;

#ac

:in? | x y xx yy -- x y 1/0
	pick2 - dup * swap
	pick3 - dup * swap +
	32 >? ( 0 nip ) ;

:dn
	xymouse
	x0 y0 in? 1? ( 'x0 'ac ! 3drop ; ) drop
	x1 y1 in? 1? ( 'x1 'ac ! 3drop ; ) drop
	x2 y2 in? 1? ( 'x2 'ac ! 3drop ; ) drop
	x3 y3 in? 1? ( 'x3 'ac ! 3drop ; ) drop
	2drop
	0 'ac ! ;

:movem
	ac 0? ( drop ; )
	xymouse pick2 4+ ! swap ! ;

:zdraw
	0 0 setxy
	zb >r
	sh ( 1? )( 1-
		sw ( 1? )( 1-
			r@+ $7fffffff <>? ( drop r zbo + @ )
			px!+
			) drop
		) drop rdrop ;

|----------------------------------
#xcam 0 #ycam 0 #zcam 1.6

#mseca

:main
	mark
	"media/3do/xwing.3do"
|	"media/3do/tie fighter.3do"
|	"media/3do/mario.3do"
|	"media/3do/8x8x8.3do"
	load3do 'Oclon !
	sw sh zb.ini
	Omode
	33
	show0 clrscr

|		matini
|		xcam ycam zcam mtrans

|		zb.clear
|		Oclon drawioct
|		Oclon2 drawioct
|		zdraw

		msec 'mseca !

		Oclon drawiso
|		$ff00 drawfull

|        drawrules

		blanco
|		dump2

		dup "%d" print cr
		maxlev "%d" print cr
		msec mseca - "%d" print cr
		lenx leny "leny %d lenx %d" print cr

        30 sw 128 - 0 xmin 10 - ymin 10 - zoomx4

|		'ivecpos >r 8 ( 1? )( 1- r@+ dup 10 >> $3ff and swap $3ff and "%d %d " print cr ) drop rdrop
|		dumpmask
        drawaxis
|        drawaxisfull
		'dn 'movem guiDnMove

        [ 1 'x1 +! ; ] <ri>
        [ -1 'x1 +! ; ] <le>
		[ szm 1+ 7 and 'szm ! ; ] <f1>
		'exit >esc< cminiflecha
		;

: main ;

